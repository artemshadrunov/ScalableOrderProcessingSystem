# Стратегия деплоя и версионирования

## Infrastructure as Code: AWS CDK

Для управления инфраструктурой и деплоя используется AWS CDK.

### Почему AWS CDK

* **Локальное тестирование** — возможность тестировать инфраструктуру локально
* **Автоматический деплой** — интеграция с CI/CD для автоматического обновления инфраструктуры
* **Версионирование** — инфраструктура как код в Git репозитории

### CI/CD интеграция

* Ручной деплой (Jenkins) или автоматический деплой (GitLab Pipeline / GitHub Actions) при merge в main ветку
* Отдельные dev, testing и release candidate окружения
* Тестирование инфраструктуры перед деплоем

## Стратегия версионирования

### Типы релизов

* **Patch-релизы** — обновляем код в текущем стэке (`vN`), имена ресурсов не меняются
* **Major-релизы** — новый стэк с префиксом версии (`v1`, `v2`, …)
* **Persistence** (DynamoDB / Aurora) не версионируется; изменения схемы проходят миграциями
* Клиент **vN** работает **только** с API **vN**

### Процесс релиза

#### Patch-релиз
1. Обновляем код Lambda, конфиги, alias внутри текущего стэка (`v2`)

#### Major-релиз
1. Деплой нового стэка `app-v3` с новым префиксом
2. Публикация клиента **v3** (API-домен уже `api-v3`)
3. Поэтапный rollout трафика (store rollout / feature-flag)
4. После перехода всех клиентов → `cfn delete-stack app-v2`

## Работа с базой данных

База данных (Aurora / DynamoDB) **общая для всех версий** и не дублируется. Мы стараемся вносить **обратимо-совместимые изменения** — добавлять поля, а не ломать старые.

### Миграция схемы

Если обратно-совместимые изменения невозможны:

1. Разворачиваем новый стэк `vN+1`, создаём новую схему/таблицы
2. Мигрируем данные в фоне
3. После проверки — выпускаем новый клиент, старым показываем «Обновите приложение»
4. Отключаем старую версию и удаляем старую схему

Так пользователи не теряют доступ и переход происходит безопаснее.

## Пример версионирования ресурсов

```csharp
var version = Environment.GetEnvironmentVariable("MAJOR_VERSION");

var orderHandler = new Function(this, $"OrderHandler-{version}", new FunctionProps
{
    FunctionName = $"order-handler-{version}",
    Runtime      = Runtime.DOTNET_8,
    // другие свойства…
});

var api = new RestApi(this, $"Api-{version}", new RestApiProps
{
    RestApiName = $"api-{version}"
});
```